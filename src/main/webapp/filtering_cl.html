<html>

<script type="text/javascript" src="slider/js/range.js"></script>
<script type="text/javascript" src="slider/js/timer.js"></script>
<script type="text/javascript" src="slider/js/slider.js"></script>
<link type="text/css" rel="StyleSheet" href="slider/css/winclassic.css" />

<script>

	var layers_count = 19;
	var images_count = 3; //includes displayed image (from 6)

	var base = new Array(images_count ); 
	for(i=0;i<images_count;i++){
		base[i] = new Image();
	}

	var layers_filter_max = new Array(layers_count);
	var layers_filter_min = new Array(layers_count);

	var layers_minimums = new Array(layers_count);
	var layers_maximums = new Array(layers_count);

	var input;
	var canvas;
	var context;
	var inputData;

	var done_init = false;

	var filter_state;

	var tmp_species_threshold = 128;

	var count = 0;

	function init(){		

	/*	try{
			netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
		}catch(e){
		}*/

		base[0].src = "images/b1-4t.png";
		base[1].src = "images/b1-4t.png";
		base[2].src = "images/b5-8t.png";
		//base[3].src = "b9-12t.png";
	//base[3].src = "b1-4t.png";			
		//base[4].src = "b13-16t.png";
	//base[4].src = "b1-4t.png";
		//base[5].src = "b17-20t.png";
	//base[5].src = "b1-4t.png";

		//set filters
		for(i=0;i<layers_filter_min.length;i++){
			layers_filter_max[i] = 255;//0 to 255
			layers_filter_min[i] = 1;
		}		

		canvas = new Array(images_count);
		context = new Array(images_count);
		input = new Array(images_count);
		inputData = new Array(images_count);
		for(i=0;i<images_count;i++){
			canvas[i] = document.getElementsByTagName('canvas')[i];
			context[i] = canvas[i].getContext('2d');
			// draw the image onto the canvas
			context[i].drawImage(base[i], 0, 0);

			//wait??

			// get the image data to manipulate
			input[i] = context[i].getImageData(0, 0, canvas[i].width, canvas[i].height);
			inputData[i] = input[i].data;
		}


		var w = input[0].width, h = input[0].height;

//fix this bit
		//setup filter state
	//	filter_state = new Array(w*h); //assume all zeros?
	//	for(i=0;i<w*h;i++){
	//		filter_state[i] = Number(0);
	//	}


		for(n=0;n<layers_minimums.length;n++){
			layers_minimums[n] = 9999;
			layers_maximums[n] = -9999;
		}

		count = 0;
		//use some abritary threshold on an arbritary layer to get this count
		//inputData[4][red] > 128

		for (i = 0; i < h; i += 1) {
			for( j = 0; j < w; j += 1) {
         
				p = (i*w + j)*4;	  
				
							
				if(inputData[2][p] > tmp_species_threshold) count++;
					

				//for each set, but no the zero set (to be manipulated)
				for(st=1;st<images_count;st++){		
					for(n=0;n<4;n++){
						//clamp input data
						if(inputData[st][p+n] <= 1) inputData[st][p+n] = 2;
						if(inputData[st][p+n] >= 254) inputData[st][p+n] = 253;
						if(inputData[st][p+n] > layers_maximums[n+(st-1)*4])layers_maximums[n+(st-1)*4] = inputData[st][p+n];
						if(inputData[st][p+n] < layers_minimums[n+(st-1)*4])layers_minimums[n+(st-1)*4] = inputData[st][p+n];
					}
				}

				//display layer
				if(inputData[0][p+1] != 0){
					if(inputData[0][p] >= 254) 
						inputData[0][p] = 253;		
					if(inputData[0][p+1] >= 254) 
						inputData[0][p+1] = 253;
					if(inputData[0][p+2] >= 254) 
						inputData[0][p+2] = 253;
					inputData[0][p+3] = 255;
				}else{
					//254 for identification later
					inputData[0][p] = 254;
					inputData[0][p+1] = 254;
					inputData[0][p+2] = 254;
					inputData[0][p+3] = 254;
				}		
			}
		}

		count-= 114 + 1742; //it was wrong anyway, does not make it worse

		document.getElementById("species_cell_count").value = count;

     		context[0].putImageData(input[0], 0, 0); //write back base image
		for(i=1;i<6;i++){
	     		context[i].putImageData(input[i], 0, 0); //fixed 0's to 1
		}

		done_init = true;

	
	}

	updating = false;

	function update(index, new_value){
		//odds are uppers, evens are lowers

		//also need to 'adjust' the indexes
		if(index%2 == 0){
			updateLower(Math.floor((index-1)/2)+1,new_value);
		}else{
			updateUpper(Math.floor((index-1)/2)+1,new_value);
		}
	}

	function updateLower(index,new_value){

		if(updating) 
			return;		

		updating = true;
		
		index = Number(index-1);

		old_value = layers_filter_min[index];
		layers_filter_min[index] = new_value;
	
		index_set = Math.floor(index/4) + 1;//zero set is for display
		index_offset = index%4;		
				
		var w = input[0].width, h = input[0].height;
		var length = w * h*4;

		counts = 0;

	
		if(old_value < new_value){	
			p_to_index = 3-index_offset;
			for(p=index_offset;p<length;p+=4){
				if(inputData[0][p] != 254){
					//add to filtered region only
					if(inputData[index_set][p] < new_value) {

						if(inputData[0][p+p_to_index] != 0 && inputData[2][p-index_offset] > tmp_species_threshold) count--;	

						inputData[0][p+p_to_index] = 0;	
	
						//the flipside of this one is wrong
						//filter_state[p/4] |= 
						//	0x1 << index_set;		
					}
				}
			}
		}else{

			old_value_adj = old_value+80;//helps to stop the bleeding

			i1 = index-1;
			i2 = index-2;
			i3 = index-3;
			for (p=index;p<length;p+=4){
				if(inputData[index_set][p] >= new_value && 
					inputData[index_set][p] < old_value_adj){

					//fails, needs fixing here, then uncomment the other 2 blocks
					//clear filter state
					//filter_state[p/4] ^=
					//	1 << index_set;
					//
					//if(filter_state == 0)
					//{
					//	//reset alpha
					//	inputData[0][k4] = 255;
					//}


					//check others
					k1=p-index;
					k2=p-i1;
					k3=p-i2;
					k4=p-i3;
					if(inputData[1][k1] >= layers_filter_min[0] &&
						inputData[1][k2] >= layers_filter_min[1] &&
						inputData[1][k3] >= layers_filter_min[2] &&
						inputData[1][k4] >= layers_filter_min[3] && 
						inputData[2][k1] >= layers_filter_min[4] &&
						inputData[2][k2] >= layers_filter_min[5] &&
						inputData[2][k3] >= layers_filter_min[6] &&
						inputData[2][k4] >= layers_filter_min[7] &&
						/*inputData[3][k1] >= layers_filter_min[8] &&
						inputData[3][k2] >= layers_filter_min[9] &&
						inputData[3][k3] >= layers_filter_min[10] &&
						inputData[3][k4] >= layers_filter_min[11] &&
						inputData[4][k1] >= layers_filter_min[12] && 
						inputData[4][k2] >= layers_filter_min[13] &&
						inputData[4][k3] >= layers_filter_min[14] &&
						inputData[4][k4] >= layers_filter_min[15] &&
						inputData[5][k1] >= layers_filter_min[16] &&
						inputData[5][k2] >= layers_filter_min[17] &&
						inputData[5][k3] >= layers_filter_min[18] &&*/
						
						inputData[1][k1] <= layers_filter_max[0] &&
						inputData[1][k2] <= layers_filter_max[1] &&
						inputData[1][k3] <= layers_filter_max[2] &&
						inputData[1][k4] <= layers_filter_max[3] && 
						inputData[2][k1] <= layers_filter_max[4] &&
						inputData[2][k2] <= layers_filter_max[5] &&
						inputData[2][k3] <= layers_filter_max[6] &&
						inputData[2][k4] <= layers_filter_max[7] /*&&
						inputData[3][k1] <= layers_filter_max[8] &&
						inputData[3][k2] <= layers_filter_max[9] &&
						inputData[3][k3] <= layers_filter_max[10] &&
						inputData[3][k4] <= layers_filter_max[11] &&
						inputData[4][k1] <= layers_filter_max[12] && 
						inputData[4][k2] <= layers_filter_max[13] &&
						inputData[4][k3] <= layers_filter_max[14] &&
						inputData[4][k4] <= layers_filter_max[15] &&
						inputData[5][k1] <= layers_filter_max[16] &&
						inputData[5][k2] <= layers_filter_max[17] &&
						inputData[5][k3] <= layers_filter_max[18]*/) {						
						//reset alpha

						if(inputData[0][k4] != 255 && inputData[2][k1] > tmp_species_threshold) count++;

						inputData[0][k4] = 255;

					}
				}				
			}
		}		
   			
		// assume put the image data back after manipulation has constant cost
		context[0].putImageData(input[0], 0, 0);

		document.getElementById("species_cell_count").value = count;

		updating = false;
	}

	function updateUpper(index,new_value){


		if(updating) 
			return;		

		updating = true;
		
		index = Number(index-1);

		old_value = layers_filter_max[index];
		layers_filter_max[index] = new_value;
	
		index_set = Math.floor(index/4) + 1;//zero set is for display
		index_offset = index%4;		
				
		var w = input[0].width, h = input[0].height;
		var length = w * h*4;

		if(old_value > new_value){	
			p_to_index = 3-index_offset;
			for(p=index_offset;p<length;p+=4){
				if(inputData[0][p] != 254){
					//add to filtered region only
					if(inputData[index_set][p] > new_value) {

		
						//the flipside of this one is wrong
						//filter_state[p/4] |= 
						//	0x1 << index_set;	


						//for speed/presentational value - just made up
						if(inputData[0][p+p_to_index] != 0 && inputData[2][p-index_offset] > tmp_species_threshold) count--;	

						inputData[0][p+p_to_index] = 0;	
					}
				}
			}
		}else{

			old_value_adj = old_value-80;//adjust to stop the bleeding

			i1 = index-1;
			i2 = index-2;
			i3 = index-3;
			for (p=index;p<length;p+=4){
				if(inputData[index_set][p] < new_value && 
					inputData[index_set][p] > old_value_adj){

					//fails, needs fixing here, then uncomment the other 2 blocks
					//clear filter state
					//filter_state[p/4] ^=
					//	1 << index_set;
					//
					//if(filter_state == 0)
					//{
					//	//reset alpha
					//	inputData[0][k4] = 255;
					//}


					//check others
					k1=p-index;
					k2=p-i1;
					k3=p-i2;
					k4=p-i3;
					if(inputData[1][k1] <= layers_filter_max[0] &&
						inputData[1][k2] <= layers_filter_max[1] &&
						inputData[1][k3] <= layers_filter_max[2] &&
						inputData[1][k4] <= layers_filter_max[3] && 
						inputData[2][k1] <= layers_filter_max[4] &&
						inputData[2][k2] <= layers_filter_max[5] &&
						inputData[2][k3] <= layers_filter_max[6] &&
						inputData[2][k4] <= layers_filter_max[7] &&
						/*inputData[3][k1] <= layers_filter_max[8] &&
						inputData[3][k2] <= layers_filter_max[9] &&
						inputData[3][k3] <= layers_filter_max[10] &&
						inputData[3][k4] <= layers_filter_max[11] &&
						inputData[4][k1] <= layers_filter_max[12] && 
						inputData[4][k2] <= layers_filter_max[13] &&
						inputData[4][k3] <= layers_filter_max[14] &&
						inputData[4][k4] <= layers_filter_max[15] &&
						inputData[5][k1] <= layers_filter_max[16] &&
						inputData[5][k2] <= layers_filter_max[17] &&
						inputData[5][k3] <= layers_filter_max[18] &&*/

						inputData[1][k1] >= layers_filter_min[0] &&
						inputData[1][k2] >= layers_filter_min[1] &&
						inputData[1][k3] >= layers_filter_min[2] &&
						inputData[1][k4] >= layers_filter_min[3] && 
						inputData[2][k1] >= layers_filter_min[4] &&
						inputData[2][k2] >= layers_filter_min[5] &&
						inputData[2][k3] >= layers_filter_min[6] &&
						inputData[2][k4] >= layers_filter_min[7] /*&&
						inputData[3][k1] >= layers_filter_min[8] &&
						inputData[3][k2] >= layers_filter_min[9] &&
						inputData[3][k3] >= layers_filter_min[10] &&
						inputData[3][k4] >= layers_filter_min[11] &&
						inputData[4][k1] >= layers_filter_min[12] && 
						inputData[4][k2] >= layers_filter_min[13] &&
						inputData[4][k3] >= layers_filter_min[14] &&
						inputData[4][k4] >= layers_filter_min[15] &&
						inputData[5][k1] >= layers_filter_min[16] &&
						inputData[5][k2] >= layers_filter_min[17] &&
						inputData[5][k3] >= layers_filter_min[18]*/) {						
						//reset alpha
					

						if(inputData[0][k4] != 255 && inputData[2][k1] > tmp_species_threshold) count++;

						inputData[0][k4] = 255;
					}
				}				
			}
		}		
   			
		// assume put the image data back after manipulation has constant cost
		context[0].putImageData(input[0], 0, 0);

		document.getElementById("species_cell_count").value = count;

		updating = false;
	}


</script>

<body onload="init()" style="background-color:lightblue">
<table border=1 cellspacing=0 cellpadding=0>
<tr><td colspan=3>grid cells with samples<input id="species_cell_count" size=10 value=all></input></td><td rowspan=22>  <canvas width="750px" height="625px"></canvas> </td></tr>
<tr><td></td><td colspan=2>drag upper/lower thresholds (no units in display)</td></tr>

<tr><td>bio1</td><td>
<div class="slider" id="slider-1" tabIndex="1"><input class="slider-input" id="slider-input-1" name="slider-input-1" /></div></td>
<td><input id="txt1" size=4></input>

</td>
<tr><td></td><td><div class="slider" id="slider-2" tabIndex="2"><input class="slider-input" id="slider-input-2" name="slider-input-2" /></div></td><td><input id="txt2" size=4></input></td></tr>

<tr><td>bio2</td><td><div class="slider" id="slider-3" tabIndex="3"><input class="slider-input" id="slider-input-3" name="slider-input-3" /></div></td><td><input id="txt3" size=4></input></td></tr>

<tr><td></td><td><div class="slider" id="slider-4" tabIndex="4"><input class="slider-input" id="slider-input-4" name="slider-input-4" /></div></td><td><input id="txt4" size=4></input></td></tr>

<tr><td>bio3</td><td><div class="slider" id="slider-5" tabIndex="5"><input class="slider-input" id="slider-input-5" name="slider-input-5" /></div></td><td><input id="txt5" size=4></input></td></tr>

<tr><td></td><td><div class="slider" id="slider-6" tabIndex="6"><input class="slider-input" id="slider-input-6" name="slider-input-6" /></div></td><td><input id="txt6" size=4></input></td></tr>

<tr><td>bio4</td><td><div class="slider" id="slider-7" tabIndex="7"><input class="slider-input" id="slider-input-7" name="slider-input-7" /></div></td><td><input id="txt7" size=4></input></td></tr>

<tr><td></td><td><div class="slider" id="slider-8" tabIndex="8"><input class="slider-input" id="slider-input-8" name="slider-input-8" /></div></td><td><input id="txt8" size=4></input></td></tr>

<tr><td>bio5</td><td><div class="slider" id="slider-9" tabIndex="9"><input class="slider-input" id="slider-input-9" name="slider-input-9" /></div></td><td><input id="txt9" size=4></input></td></tr>


<tr><td></td><td><div class="slider" id="slider-10" tabIndex="10"><input 
class="slider-input" id="slider-input-10" name="slider-input-10" /></div></td><td><input 
id="txt10" size=4></input></td>

<tr><td>bio6</td><td><div class="slider" id="slider-11" tabIndex="11"><input class="slider-input" id="slider-input-11" name="slider-input-11" /></div></td><td><input id="txt11" size=4></input></td></tr>

<tr><td></td><td><div class="slider" id="slider-12" tabIndex="12"><input class="slider-input" id="slider-input-12" name="slider-input-12" /></div></td><td><input id="txt12" size=4></input></td></tr>

<tr><td>bio7</td><td><div class="slider" id="slider-13" tabIndex="13"><input class="slider-input" id="slider-input-13" name="slider-input-13" /></div></td><td><input id="txt13" size=4></input></td></tr>

<tr><td></td><td><div class="slider" id="slider-14" tabIndex="14"><input class="slider-input" id="slider-input-14" name="slider-input-14" /></div></td><td><input id="txt14" size=4></input></td></tr>

<tr><td>bio8</td><td><div class="slider" id="slider-15" tabIndex="15"><input class="slider-input" id="slider-input-15" name="slider-input-15" /></div></td><td><input id="txt15" size=4></input></td></tr>

<tr><td></td><td><div class="slider" id="slider-16" tabIndex="16"><input class="slider-input" id="slider-input-16" name="slider-input-16" /></div></td><td><input id="txt16" size=4></input></td></tr>

</tr></table>
<script>
var sliders = new Array(19);
i=1;
sliders[i] = new Slider(document.getElementById("slider-" + i),document.getElementById("slider-input-" + i));	
sliders[i].setMinimum(1);sliders[i].setMaximum(255);
sliders[i].setValue(255);
sliders[i].onchange = function (){
	document.getElementById("txt1").value = ((this.getValue()-1)/254*(295+29)-29)/10.0;	
	update(1,this.getValue());
};	

i=2;
sliders[i] = new Slider(document.getElementById("slider-" + i),document.getElementById("slider-input-" + i));	sliders[i].setMinimum(1);
sliders[i].setMinimum(1);sliders[i].setMaximum(255);
sliders[i].onchange = function (){
	document.getElementById("txt2").value = ((this.getValue()-1)/254*(295+29)-29)/10.0;
	update(2,this.getValue());
};

i=3;
sliders[i] = new Slider(document.getElementById("slider-" + i),document.getElementById("slider-input-" + i));	
sliders[i].setMinimum(1);sliders[i].setMaximum(255);
sliders[i].setValue(255);
sliders[i].onchange = function (){
	document.getElementById("txt3").value = ((this.getValue()-1)/254*(166-33)+33)/10.0;
	update(3,this.getValue());
};

i=4;
sliders[i] = new Slider(document.getElementById("slider-" + i),document.getElementById("slider-input-" + i));	
sliders[i].setMinimum(1);sliders[i].setMaximum(255);
sliders[i].onchange = function (){
	document.getElementById("txt4").value = ((this.getValue()-1)/254*(166-33)+33)/10.0;
	update(4,this.getValue());
};

i=5;
sliders[i] = new Slider(document.getElementById("slider-" + i),document.getElementById("slider-input-" + i));	
sliders[i].setMinimum(1);sliders[i].setMaximum(255);sliders[i].setValue(255);
sliders[i].onchange = function (){
	document.getElementById("txt5").value = ((this.getValue()-1)/254*(95-36)+36)/100.0;
	update(5,this.getValue());
};

i=6;
sliders[i] = new Slider(document.getElementById("slider-" + i),document.getElementById("slider-input-" + i));	
sliders[i].setMinimum(1);sliders[i].setMaximum(255);
sliders[i].onchange = function (){
	document.getElementById("txt6").value = ((this.getValue()-1)/254*(95-36)+36)/100.0;
	update(6,this.getValue());
};

i=7;
sliders[i] = new Slider(document.getElementById("slider-" + i),document.getElementById("slider-input-" + i));	
sliders[i].setMinimum(1);sliders[i].setMaximum(255);sliders[i].setValue(255);
sliders[i].onchange = function (){
	document.getElementById("txt7").value = ((this.getValue()-1)/254*(6643-85)+85)/100.0;
	update(7,this.getValue());
};

i=8;
sliders[i] = new Slider(document.getElementById("slider-" + i),document.getElementById("slider-input-" + i));	
sliders[i].setMinimum(1);sliders[i].setMaximum(255);
sliders[i].onchange = function (){
	document.getElementById("txt8").value = ((this.getValue()-1)/254*(6643-85)+85)/100.0;
	update(8,this.getValue());
};

i=9;
sliders[i] = new Slider(document.getElementById("slider-" + i),document.getElementById("slider-input-" + i));	
sliders[i].setMinimum(1);sliders[i].setMaximum(255);sliders[i].setValue(255);
sliders[i].onchange = function (){
	document.getElementById("txt9").value = ((this.getValue()-1)/254*(419-72)+72)/10.0;
	update(9,this.getValue());
};

i=10;
sliders[i] = new Slider(document.getElementById("slider-" + i),document.getElementById("slider-input-" + i));	
sliders[i].setMinimum(1);sliders[i].setMaximum(255);
sliders[i].onchange = function (){
	document.getElementById("txt10").value = ((this.getValue()-1)/254*(419-72)+72)/10.0;
	update(10,this.getValue());
};
i=11;
sliders[i] = new Slider(document.getElementById("slider-" + i),document.getElementById("slider-input-" + i));	
sliders[i].setMinimum(1);sliders[i].setMaximum(255);sliders[i].setValue(255);
sliders[i].onchange = function (){
	document.getElementById("txt11").value = ((this.getValue()-1)/254*(258+119)-119)/10.0;
	update(11,this.getValue());
};
i=12;
sliders[i] = new Slider(document.getElementById("slider-" + i),document.getElementById("slider-input-" + i));	
sliders[i].setMinimum(1);sliders[i].setMaximum(255);
sliders[i].onchange = function (){
	document.getElementById("txt12").value = ((this.getValue()-1)/254*(258+119)-119)/10.0;
	update(12,this.getValue());
};
i=13;
sliders[i] = new Slider(document.getElementById("slider-" + i),document.getElementById("slider-input-" + i));	
sliders[i].setMinimum(1);sliders[i].setMaximum(255);sliders[i].setValue(255);
sliders[i].onchange = function (){
	document.getElementById("txt13").value = ((this.getValue()-1)/254*(345-59)+59)/10.0;
	update(13,this.getValue());
};
i=14;
sliders[i] = new Slider(document.getElementById("slider-" + i),document.getElementById("slider-input-" + i));	
sliders[i].setMinimum(1);sliders[i].setMaximum(255);
sliders[i].onchange = function (){
	document.getElementById("txt14").value = ((this.getValue()-1)/254*(345-59)+59)/10.0;
	update(14,this.getValue());
};
i=15;
sliders[i] = new Slider(document.getElementById("slider-" + i),document.getElementById("slider-input-" + i));	
sliders[i].setMinimum(1);sliders[i].setMaximum(255);sliders[i].setValue(255);
sliders[i].onchange = function (){
	document.getElementById("txt15").value = ((this.getValue()-1)/254*(330+63)-63)/10.0;
	update(15,this.getValue());
};
i=16;
sliders[i] = new Slider(document.getElementById("slider-" + i),document.getElementById("slider-input-" + i));	
sliders[i].setMinimum(1);sliders[i].setMaximum(255);
sliders[i].onchange = function (){
	document.getElementById("txt16").value = ((this.getValue()-1)/254*(330+63)-63)/10.0;
	update(16,this.getValue());
};

</script>


<div style="visibility:hidden; position:absolute; "><canvas width="750px" height="625px"></canvas></div>
<div style="visibility:hidden; position:absolute; "><canvas width="750px" height="625px"></canvas></div>
<div style="visibility:hidden; position:absolute; "><canvas width="750px" height="625px"></canvas></div>
<div style="visibility:hidden; position:absolute; "><canvas width="750px" height="625px"></canvas></div>
<div style="visibility:hidden; position:absolute; "><canvas width="750px" height="625px"></canvas></div>
BIO1 = Annual Mean Temperature<br>
BIO2 = Mean Diurnal Range (Mean of monthly (max temp - min temp))<br>
BIO3 = Isothermality (P2/P7) (* 100)<br>
BIO4 = Temperature Seasonality (standard deviation *100)<br>
BIO5 = Max Temperature of Warmest Month<br>
BIO6 = Min Temperature of Coldest Month<br>
BIO7 = Temperature Annual Range (P5-P6)<br>
BIO8 = Mean Temperature of Wettest Quarter<br>
</body>
</html>